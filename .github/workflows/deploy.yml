name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main  # or 'master', depending on your default branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          # Set project directory
          APP_DIR=~/my-app

          # Clone or pull repo
          if [ ! -d "$APP_DIR/.git" ]; then
            rm -rf $APP_DIR
            git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git $APP_DIR
          else
            cd $APP_DIR
            git pull origin main
          fi

          cd $APP_DIR

          # Install Python and pip if needed
          sudo yum install -y python3 git

          # Set up virtualenv
          python3 -m venv venv
          source venv/bin/activate

          # Install requirements
          pip install --upgrade pip
          

          # Restart Flask app with gunicorn and pm2
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi

          pm2 restart flask-app || pm2 start venv/bin/gunicorn --name flask-app -w 4 -b 0.0.0.0:8000 app:app

        EOF
